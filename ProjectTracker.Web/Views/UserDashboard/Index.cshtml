@model ProjectTracker.Service.DTOs.DashboardDto
@using System.Linq
@{
    ViewData["Title"] = "Kontrol Paneli";
}

<h1>Kontrol Paneli</h1>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-body text-center">
                <img src="https://ui-avatars.com/api/?name=@Model.UserName&background=0D8ABC&color=fff&size=96" class="rounded-circle mb-3" alt="Avatar" width="96" height="96" />
                <h4 class="card-title mb-1">@Model.FullName</h4>
                <p class="text-muted mb-2">@User.Identity.Name</p>
                <div class="mb-2">
                    @foreach (var role in Model.UserRoles)
                    {
                        if (role == "Admin")
                        {
                            <span class="badge bg-danger me-1">Admin</span>
                        }
                        else if (role == "Manager")
                        {
                            <span class="badge bg-warning text-dark me-1">Yönetici</span>
                        }
                        else if (role == "Employee")
                        {
                            <span class="badge bg-info text-dark me-1">Çalışan</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary me-1">@role</span>
                        }
                    }
                </div>
                <a asp-controller="Account" asp-action="Profile" class="btn btn-outline-primary btn-sm mb-1">
                    <i class="fas fa-user"></i> Profilim
                </a>
                <a asp-controller="Account" asp-action="ChangePassword" class="btn btn-outline-secondary btn-sm mb-1">
                    <i class="fas fa-key"></i> Şifre Değiştir
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <h2>Hoş Geldiniz, @Model.UserName!</h2>
        <p>
            Sistem rolleri:
            @foreach (var role in Model.UserRoles)
            {
                <span class="badge bg-info">@role</span>
            }
        </p>
    </div>
</div>

<!-- Active Projects Widget -->
@if (Model.ActiveProjects != null && Model.ActiveProjects.Any())
{
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <i class="fas fa-project-diagram"></i> Aktif Projelerim
                </div>
                <div class="card-body">
                    <div class="row">
                        @foreach (var project in Model.ActiveProjects)
                        {
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card h-100 border-primary">
                                    <div class="card-body">
                                        <h5 class="card-title">@project.Name</h5>
                                        <p class="card-text text-muted">Durum: <span class="badge bg-info">@project.Status</span></p>
                                        <!-- Placeholder progress bar -->
                                        <div class="progress mb-2">
                                            <div class="progress-bar bg-primary" role="progressbar" style="width: 60%" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100">60%</div>
                                        </div>
                                        <a asp-controller="Project" asp-action="Details" asp-route-id="@project.Id" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-info-circle"></i> Detaylar
                                        </a>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Work Log Summary Widget -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
                <i class="fas fa-clock"></i> Çalışma Özeti
            </div>
            <div class="card-body">
                <p>Bu hafta: <strong>40</strong> saat</p>
                <p>Bu ay: <strong>120</strong> saat</p>
                <!-- Placeholder for chart -->
                <div class="bg-light border rounded p-3 text-center">
                    <em>Çalışma saatleri grafiği (placeholder)</em>
                </div>
            </div>
        </div>
    </div>
    <!-- Notifications Widget -->
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
                <i class="fas fa-bell"></i> Bildirimler
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li><i class="fas fa-envelope-open-text text-primary"></i> 2 yeni mesajınız var</li>
                    <li><i class="fas fa-tasks text-success"></i> 1 onay bekleyen iş kaydı</li>
                    <li><i class="fas fa-exclamation-circle text-danger"></i> 1 sistem uyarısı</li>
                </ul>
            </div>
        </div>
    </div>
</div>
<!-- Quick Actions Row -->
<div class="row mb-4">
    <div class="col-12 text-center">
        <a asp-controller="WorkLog" asp-action="Create" class="btn btn-success mx-2 mb-2">
            <i class="fas fa-plus"></i> İş Kaydı Ekle
        </a>
        <a href="#" class="btn btn-outline-primary mx-2 mb-2">
            <i class="fas fa-calendar-alt"></i> İzin Talep Et
        </a>
        <a asp-controller="Project" asp-action="Create" class="btn btn-outline-info mx-2 mb-2">
            <i class="fas fa-folder-plus"></i> Proje Oluştur
        </a>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Toplam Proje</h5>
                <p class="card-text display-4">@Model.Stats.TotalProjects</p>
            </div>
        </div>
    </div>
</div>

@if (Model.ProjectReports != null && Model.ProjectReports.Any())
{
    var labelsJson = System.Text.Json.JsonSerializer.Serialize(Model.ProjectReports.Select(p => p.ProjectName));
    var budgetJson = System.Text.Json.JsonSerializer.Serialize(Model.ProjectReports.Select(p => p.Budget));
    var actualJson = System.Text.Json.JsonSerializer.Serialize(Model.ProjectReports.Select(p => p.ActualCost));

    <div class="row mt-4">
        <div class="col-md-6">
            <h3>Proje Süre ve Maliyet</h3>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Proje</th>
                        <th>Toplam Saat</th>
                        <th>Toplam Maliyet</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var report in Model.ProjectReports)
                    {
                        <tr>
                            <td>@report.ProjectName</td>
                            <td>@report.TotalHours</td>
                            <td>@report.TotalCost.ToString("C")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="col-md-6">
            <h3>Bütçe vs Gerçekleşen</h3>
            <canvas id="budgetChart"></canvas>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const labels = @Html.Raw(labelsJson);
        const budgets = @Html.Raw(budgetJson);
        const actuals = @Html.Raw(actualJson);
        new Chart(document.getElementById('budgetChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Bütçe',
                        data: budgets,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)'
                    },
                    {
                        label: 'Gerçekleşen',
                        data: actuals,
                        backgroundColor: 'rgba(255, 99, 132, 0.5)'
                    }
                ]
            }
        });
    </script>
}

@if (Model.RecentWorkLogs != null && Model.RecentWorkLogs.Any())
{
    <div class="row mt-4">
        <div class="col-md-12">
            <h3>Son İş Kayıtları</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Proje</th>
                        <th>Açıklama</th>
                        <th>Tarih</th>
                        <th>Süre</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var workLog in Model.RecentWorkLogs)
                    {
                        <tr>
                            <td>@workLog.ProjectName</td>
                            <td>@workLog.Description</td>
                            <td>@workLog.WorkDate.ToString("dd.MM.yyyy")</td>
                            <td>@workLog.HoursSpent saat</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}
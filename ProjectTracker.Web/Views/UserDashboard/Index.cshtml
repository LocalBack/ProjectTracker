@model ProjectTracker.Service.DTOs.DashboardDto
@using System.Linq
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer L
@{
    ViewData["Title"] = L["ControlPanel"];
}

<h1>@L["ControlPanel"]</h1>

<div class="mb-3">
    <form asp-action="ExportWorkLogs" method="post" class="d-inline">
        <input type="hidden" name="format" value="Excel" />
        <button type="submit" class="btn btn-success btn-sm">Export Work Logs to Excel</button>
    </form>
    <form asp-action="ExportWorkLogs" method="post" class="d-inline">
        <input type="hidden" name="format" value="Pdf" />
        <button type="submit" class="btn btn-danger btn-sm">Export Work Logs to PDF</button>
    </form>
</div>

<div class="mb-3">
    <form asp-action="ExportActivity" method="post" class="d-inline">
        <input type="hidden" name="format" value="Excel" />
        <button type="submit" class="btn btn-success btn-sm">Export Activity to Excel</button>
    </form>
    <form asp-action="ExportActivity" method="post" class="d-inline">
        <input type="hidden" name="format" value="Pdf" />
        <button type="submit" class="btn btn-danger btn-sm">Export Activity to PDF</button>
    </form>
</div>

<div class="mb-3">
    <form asp-action="ExportPerformance" method="post" class="d-inline">
        <input type="hidden" name="format" value="Excel" />
        <button type="submit" class="btn btn-success btn-sm">Export Performance to Excel</button>
    </form>
    <form asp-action="ExportPerformance" method="post" class="d-inline">
        <input type="hidden" name="format" value="Pdf" />
        <button type="submit" class="btn btn-danger btn-sm">Export Performance to PDF</button>
    </form>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-body text-center">
                <img src="https://ui-avatars.com/api/?name=@Model.UserName&background=0D8ABC&color=fff&size=96" class="rounded-circle mb-3" alt="Avatar" width="96" height="96" />
                <h4 class="card-title mb-1">@Model.FullName</h4>
                <p class="text-muted mb-2">@User.Identity.Name</p>
                <div class="mb-2">
                    @foreach (var role in Model.UserRoles)
                    {
                        if (role == "Admin")
                        {
                            <span class="badge bg-danger me-1">Admin</span>
                        }
                        else if (role == "Manager")
                        {
                            <span class="badge bg-warning text-dark me-1">Yönetici</span>
                        }
                        else if (role == "Employee")
                        {
                            <span class="badge bg-info text-dark me-1">Çalışan</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary me-1">@role</span>
                        }
                    }
                </div>
                <a asp-controller="Account" asp-action="Profile" class="btn btn-outline-primary btn-sm mb-1">
                    <i class="fas fa-user"></i> @L["MyProfile"]
                </a>
                <a asp-controller="Account" asp-action="ChangePassword" class="btn btn-outline-secondary btn-sm mb-1">
                    <i class="fas fa-key"></i> @L["ChangePassword"]
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <h2>@L["WelcomeUser", Model.UserName]</h2>
        <p>
            @L["SystemRoles"]:
            @foreach (var role in Model.UserRoles)
            {
                <span class="badge bg-info">@role</span>
            }
        </p>
    </div>
</div>


<!-- Active Projects Widget -->
@if ((Model.UserRoles.Contains("Employee") || Model.UserRoles.Contains("Manager")) && Model.ActiveProjects != null && Model.ActiveProjects.Any())

{
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <i class="fas fa-project-diagram"></i> @L["MyProjects"]
                </div>
                <div class="card-body">
                    <div class="row">
                        @foreach (var project in Model.ActiveProjects)
                        {
                            var statusClass = project.Status switch
                            {
                                ProjectTracker.Core.Entities.ProjectStatus.Planning => "bg-secondary",
                                ProjectTracker.Core.Entities.ProjectStatus.Active => "bg-primary",
                                ProjectTracker.Core.Entities.ProjectStatus.OnHold => "bg-warning text-dark",
                                ProjectTracker.Core.Entities.ProjectStatus.Completed => "bg-success",
                                ProjectTracker.Core.Entities.ProjectStatus.Cancelled => "bg-danger",
                                _ => "bg-secondary"
                            };
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card h-100 border-primary">
                                    <div class="card-body">
                                        <h5 class="card-title">@project.Name</h5>
                                        <p class="card-text text-muted">@L["Status"]: <span class="badge @statusClass">@project.StatusText</span></p>
                                        <div class="progress mb-2">
                                            <div class="progress-bar bg-primary" role="progressbar" style="width: @project.CompletionPercent%" aria-valuenow="@project.CompletionPercent" aria-valuemin="0" aria-valuemax="100">@project.CompletionPercent%</div>
                                        </div>
                                        <a asp-controller="Project" asp-action="Details" asp-route-id="@project.Id" class="btn btn-outline-primary btn-sm me-1">
                                            <i class="fas fa-info-circle"></i> Go to Project
                                        </a>
                                        <a asp-controller="Task" asp-action="Index" asp-route-projectId="@project.Id" class="btn btn-outline-secondary btn-sm">
                                            <i class="fas fa-tasks"></i> View Tasks
                                        </a>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Work Log Summary Widget -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
                <i class="fas fa-clock"></i> @L["WorkSummary"]
            </div>
            <div class="card-body">
                <p>@L["ThisWeek"]: <strong>@Model.Stats.TotalHoursThisWeek</strong> @L["Hours"]</p>
                <p>@L["ThisMonth"]: <strong>@Model.Stats.TotalHoursThisMonth</strong> @L["Hours"]</p>
                <canvas id="workChart"></canvas>
            </div>
        </div>
    </div>
    <!-- Notifications Widget -->
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
                <i class="fas fa-bell"></i> @L["Notifications"]
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    <a href="/WorkLog/Approvals" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-tasks text-success me-2"></i>@L["PendingApprovals"]</span>
                        <span class="badge bg-secondary">@Model.Stats.PendingApprovals</span>
                    </a>
                    <a href="/Messages/Inbox" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-envelope-open-text text-primary me-2"></i>@L["UnreadMessages"]</span>
                        <span class="badge bg-secondary">@Model.Stats.UnreadMessages</span>
                    </a>
                    <a href="/SystemAlerts" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-exclamation-circle text-danger me-2"></i>@L["SystemAlerts"]</span>
                        <span class="badge bg-secondary">@Model.Stats.SystemAlerts</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Quick Actions Row -->
<div class="row mb-4">
    <div class="col-12 text-center">
        <a asp-controller="WorkLog" asp-action="Create" class="btn btn-success mx-2 mb-2">
            <i class="fas fa-plus"></i> @L["AddWorkLog"]
        </a>
        <a href="#" class="btn btn-outline-primary mx-2 mb-2">
            <i class="fas fa-calendar-alt"></i> @L["RequestLeave"]
        </a>
        <a asp-controller="Project" asp-action="Create" class="btn btn-outline-info mx-2 mb-2">
            <i class="fas fa-folder-plus"></i> @L["CreateProject"]
        </a>
    </div>
</div>


@if (Model.UserRoles.Contains("Admin"))
{
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">System Projects</h5>
                    <p class="card-text display-4">@Model.Stats.TotalProjects</p>
                </div>

            </div>
        </div>
    </div>
}
else if (Model.UserRoles.Contains("Manager"))
{
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Team Projects</h5>
                    <p class="card-text display-4">@Model.Stats.TotalProjects</p>
                </div>
            </div>
        </div>
    </div>
}
else if (Model.UserRoles.Contains("Employee"))
{
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">@L["TotalProjects"]</h5>
                    <p class="card-text display-4">@Model.Stats.TotalProjects</p>
                </div>
            </div>
        </div>
    </div>
}

@if (Model.ProjectReports != null && Model.ProjectReports.Any())
{
    <div class="row mt-4">
        <div class="col-md-6">
            <h3>@L["ProjectTimeCost"]</h3>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>@L["Project"]</th>
                        <th>@L["TotalHours"]</th>
                        <th>@L["TotalCost"]</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var report in Model.ProjectReports)
                    {
                        <tr>
                            <td>@report.ProjectName</td>
                            <td>@report.TotalHours</td>
                            <td>@report.TotalCost.ToString("C")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="col-md-6">
            <h3>@L["BudgetVsActual"]</h3>
            <canvas id="budgetChart"></canvas>
        </div>
    </div>
}

@if (Model.RecentWorkLogs != null && Model.RecentWorkLogs.Any())
{
    <div class="row mt-4">
        <div class="col-md-12">
            <h3>@L["RecentWorkLogs"]</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>@L["Date"]</th>
                        <th>@L["Title"]</th>
                        <th>@L["Project"]</th>
                        <th>@L["Duration"]</th>
                        <th>@L["Status"]</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var workLog in Model.RecentWorkLogs)
                    {
                        <tr>
                            <td>@workLog.WorkDate.ToString("dd.MM.yyyy")</td>
                            <td>@workLog.Title</td>
                            <td>@workLog.ProjectName</td>
                            <td>@workLog.HoursSpent</td>
                            <td>@L["Logged"]</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

@if (Model.RecentEquipmentActions != null && Model.RecentEquipmentActions.Any())
{
    <div class="row mt-4">
        <div class="col-md-12">
            <h3>@L["RecentEquipmentActions"]</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>@L["Date"]</th>
                        <th>@L["Equipment"]</th>
                        <th>@L["Description"]</th>
                        <th>@L["Status"]</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var action in Model.RecentEquipmentActions)
                    {
                        <tr>
                            <td>@action.Date.ToString("dd.MM.yyyy")</td>
                            <td>@action.Equipment</td>
                            <td>@action.Description</td>
                            <td>@action.Status</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const weeklyData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Stats.WeeklyHours));
        const weeklyLabels = ['Week 1','Week 2','Week 3','Week 4'];
        new Chart(document.getElementById('workChart'), {
            type: 'bar',
            data: {
                labels: weeklyLabels,
                datasets: [{
                    label: '@L["Hours"]',
                    data: weeklyData,
                    backgroundColor: 'rgba(75, 192, 192, 0.5)'
                }]
            }
        });
        @if (Model.ProjectReports != null && Model.ProjectReports.Any())
        {
            <text>
            const labels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ProjectReports.Select(p => p.ProjectName)));
            const budgets = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ProjectReports.Select(p => p.Budget)));
            const actuals = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ProjectReports.Select(p => p.ActualCost)));
            new Chart(document.getElementById('budgetChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '@L["Budget"]',
                            data: budgets,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)'
                        },
                        {
                            label: '@L["Actual"]',
                            data: actuals,
                            backgroundColor: 'rgba(255, 99, 132, 0.5)'
                        }
                    ]
                }
            });
            </text>
        }
    </script>
}
